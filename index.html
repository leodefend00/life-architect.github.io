<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograpp - Gestión de Cronogramas</title>
    
    <!-- Librerías Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Configuración Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' }
                    },
                    screens: { 'print': {'raw': 'print'} }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        .dark ::-webkit-scrollbar-track { background: #09090b; }
        .dark ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #2563eb; }
        ::-webkit-scrollbar-track { background: #f4f4f5; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #2563eb; }

        /* --- ESTILOS DE IMPRESIÓN PROFESIONAL --- */
        @media print {
            @page { size: landscape; margin: 0.5cm; }
            
            body { 
                background-color: white !important; 
                color: #000 !important; 
                font-size: 9pt !important;
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
            
            .no-print, aside, button, .modal-overlay, .user-profile, select, .mobile-menu-btn, .cloud-status-banner { 
                display: none !important; 
            }
            
            /* Contenedor tipo Tabla */
            .print-view-container { 
                display: block !important; 
                height: auto !important; 
                overflow: visible !important; 
                margin-bottom: 20px !important; 
                page-break-inside: avoid; 
                border: 1px solid #999 !important;
                background-color: white !important;
            }
            
            .print-hidden { display: none !important; }
            
            /* Resetear colores */
            .bg-zinc-950, .bg-zinc-900, .bg-black, .dark .bg-zinc-950, .dark .bg-zinc-900, .dark .bg-black { 
                background-color: white !important; 
                color: black !important;
            }
            
            .text-zinc-200, .text-zinc-300, .text-zinc-400, .text-zinc-500, .text-white, .dark .text-white { 
                color: #000 !important; 
            }
            
            .border-zinc-800, .dark .border-zinc-800, .border-zinc-200 { 
                border-color: #999 !important; 
            }
            
            /* Encabezados de tabla */
            .print-header {
                background-color: #e5e5e5 !important; 
                color: #000 !important;
                font-weight: 800 !important;
                text-transform: uppercase !important;
                font-size: 8pt !important;
                padding: 6px 4px !important;
                border-bottom: 2px solid #000 !important;
                border-right: 1px solid #999 !important;
            }
            
            /* Celdas con separación */
            .print-cell {
                padding: 6px 8px !important;
                border-right: 1px solid #ccc !important; /* Línea vertical divisoria */
            }
            .print-cell:last-child {
                border-right: none !important;
            }
            
            /* Filas */
            .print-row {
                border-bottom: 1px solid #ccc !important;
            }

            main { margin: 0 !important; padding: 0 !important; width: 100% !important; display: block !important; }
            .h-screen { height: auto !important; overflow: visible !important; }
            .flex-1 { flex: none !important; overflow: visible !important; }
            .overflow-x-auto, .overflow-y-auto { overflow: visible !important; }
            
            .print-title { 
                display: block !important; 
                font-size: 14pt !important; 
                font-weight: bold; 
                padding: 10px;
                border-bottom: 2px solid #000;
                text-align: center;
                text-transform: uppercase;
                margin-bottom: 0 !important;
            }
            
            /* Colores de barras */
            .bar-base { background-color: #eee !important; border: 1px solid #999 !important; }
            .bar-fill { background-color: #2563eb !important; } 
            .bar-late { background-color: #fee2e2 !important; border: 1px solid #991b1b !important; }
            
            .print-only { display: block !important; }
        }
        
        .print-only { display: none; }
        .print-title { display: none; }
    </style>
</head>
<body class="bg-white text-zinc-900 dark:bg-black dark:text-e4e4e7">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const GLOBAL_ROOM_ID = "proyecto-maestro-v1";

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAUiRqoUjkVQdfpN2IVGUAHjd8SIWi8J6Q",
            authDomain: "cronogramastack.firebaseapp.com",
            projectId: "cronogramastack",
            storageBucket: "cronogramastack.firebasestorage.app",
            messagingSenderId: "1077254109806",
            appId: "1:1077254109806:web:ca59b3a41aa22aacb2447f"
        };

        let db = null;
        let auth = null;
        let firebaseReady = false;

        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                firebaseReady = true;
            }
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
        }

        const Icons = {
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg>,
            Calendar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
            Pencil: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>,
            Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
            Clock: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
            Alert: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>,
            Folder: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
            ChevronRight: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"/></svg>,
            Printer: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>,
            Home: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>,
            Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
            Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
            User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>,
            LogOut: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
            Box: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>,
            Flag: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 21v-8a2 2 0 012-2h14a2 2 0 012 2v8M3 21h18M5 10a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2H7a2 2 0 01-2-2v-8z"/></svg>,
            Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>,
            Sun: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
            Moon: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>,
            Download: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
            Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,
            Cloud: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>,
            Link: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>,
            Warning: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatDateDisplay = (dateStr) => {
            if(!dateStr) return '--';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`; // Año completo
        };
        const getDaysDiff = (start, end) => Math.round(Math.abs((new Date(end) - new Date(start)) / (24 * 60 * 60 * 1000)));

        const GanttChart = ({ tasks, onDelete, onEdit }) => {
            const scheduledTasks = tasks.filter(t => t.start && t.end);

            if (scheduledTasks.length === 0) return (
                <div className="flex flex-col items-center justify-center h-64 text-zinc-500 border border-zinc-200 dark:border-zinc-800 rounded-xl bg-white dark:bg-zinc-900/50 border-dashed">
                    <Icons.Calendar />
                    <p className="mt-2 text-center px-4">No hay tareas programadas con fechas para mostrar en el cronograma.</p>
                </div>
            );

            const dates = scheduledTasks.flatMap(t => [new Date(t.start), new Date(t.end)]);
            const minDate = new Date(Math.min(...dates)); minDate.setDate(minDate.getDate() - 2);
            const maxDate = new Date(Math.max(...dates)); maxDate.setDate(maxDate.getDate() + 5);
            const totalDays = getDaysDiff(minDate, maxDate) + 1;
            const timelineDays = Array.from({length: totalDays}, (_, i) => {
                const d = new Date(minDate); d.setDate(d.getDate() + i); return d;
            });

            const getPosition = (dateStr) => (getDaysDiff(minDate, new Date(dateStr)) / totalDays) * 100;
            const getWidth = (startStr, endStr) => ((getDaysDiff(new Date(startStr), new Date(endStr)) + 1) / totalDays) * 100;

            const getBarColors = (status, endStr) => {
                const today = new Date().toISOString().split('T')[0];
                const isLate = status !== 'Completado' && endStr < today;
                
                let baseClass = "bg-zinc-200 dark:bg-zinc-800"; 
                if (isLate) baseClass = "bg-red-200 dark:bg-red-900/30 bar-late";
                
                const fillClass = "bg-blue-600 bar-fill";

                return { baseClass, fillClass, isLate };
            };

            return (
                <div className="flex flex-col h-full bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden shadow-sm dark:shadow-xl print-container">
                    <div className="print-title text-zinc-900">Cronograma de Actividades (Gantt)</div>
                    <div className="flex border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-black overflow-x-auto hide-scrollbar">
                        <div className="w-48 flex-shrink-0 p-3 text-sm font-bold text-zinc-500 dark:text-zinc-400 border-r border-zinc-200 dark:border-zinc-800 sticky left-0 bg-zinc-50 dark:bg-black z-10 print-header">Tarea</div>
                        <div className="flex-1 relative h-10 min-w-[600px]">
                            {timelineDays.map((day, i) => (
                                <div key={i} className="absolute border-l border-zinc-200 dark:border-zinc-800 h-full flex items-center justify-center text-[10px] text-zinc-500 dark:text-zinc-600" 
                                     style={{left: `${(i/totalDays)*100}%`, width: `${(1/totalDays)*100}%`}}>{day.getDate()}</div>
                            ))}
                        </div>
                    </div>
                    <div className="overflow-y-auto overflow-x-auto custom-scrollbar flex-1 relative bg-white dark:bg-zinc-900/50">
                        {scheduledTasks.map((task, index) => {
                            const left = getPosition(task.start);
                            const width = getWidth(task.start, task.end);
                            const { baseClass, fillClass, isLate } = getBarColors(task.status, task.end);
                            
                            return (
                                <div key={task.id} className="flex border-b border-zinc-100 dark:border-zinc-800/50 hover:bg-zinc-50 dark:hover:bg-zinc-800/30 transition-colors group print-row">
                                    <div className="w-48 flex-shrink-0 p-3 border-r border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900/80 sticky left-0 z-10 flex justify-between items-center group print-task-label print-cell">
                                        <div className="truncate pr-2 w-full flex items-center gap-2">
                                            <span className="text-xs font-mono text-zinc-400">#{index + 1}</span>
                                            <div className="flex-1 min-w-0">
                                                <div className="text-sm text-zinc-800 dark:text-zinc-200 font-medium truncate" title={task.name}>{task.name}</div>
                                                <div className={`text-xs flex items-center gap-1 no-print ${isLate ? 'text-red-500' : 'text-zinc-500'}`}>{isLate && <Icons.Alert />} {formatDateDisplay(task.start)}</div>
                                            </div>
                                        </div>
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity no-print">
                                            <button onClick={() => onEdit(task)} className="text-zinc-400 hover:text-blue-500 dark:text-zinc-600 dark:hover:text-blue-400"><Icons.Pencil /></button>
                                            <button onClick={() => onDelete(task.id)} className="text-zinc-400 hover:text-red-500 dark:text-zinc-600 dark:hover:text-red-500"><Icons.Trash /></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 relative h-14 min-w-[600px]">
                                        {timelineDays.map((_, i) => <div key={i} className="absolute border-l border-zinc-100 dark:border-zinc-800/30 h-full" style={{left: `${(i/totalDays)*100}%`}}></div>)}
                                        <div 
                                            className={`absolute top-3 h-8 rounded-md shadow-sm ${baseClass} bar-base flex items-center px-1 overflow-visible whitespace-nowrap transition-all hover:brightness-110 cursor-pointer print-bar group-task`}
                                            style={{ left: `${left}%`, width: `${width}%`, minWidth: '35px' }} 
                                            title={`Entregable: ${task.deliverable || 'N/A'}`} 
                                            onClick={() => onEdit(task)}
                                        >
                                            <div className={`absolute left-0 top-0 bottom-0 rounded-l-md ${fillClass}`} style={{width: `${task.progress}%`, borderRadius: task.progress === 100 ? '6px' : '6px 0 0 6px'}}></div>
                                            <span className={`text-[10px] font-bold z-10 relative ml-1 ${task.progress > 50 ? 'text-white' : 'text-zinc-600 dark:text-zinc-300'}`}>
                                                {task.progress}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const TaskListView = ({ tasks, onDelete, onEdit, onStatusChange }) => {
            return (
                <div className="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden shadow-sm dark:shadow-xl flex flex-col print-view-container animate-in fade-in slide-in-from-bottom-4 duration-500 overflow-x-auto">
                    <div className="print-title text-zinc-900">Detalle de Actividades</div>
                    <div className="min-w-[800px] grid grid-cols-12 gap-4 p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-950 font-bold text-zinc-500 dark:text-zinc-400 text-sm print-header uppercase tracking-wider">
                        <div className="col-span-1">#</div>
                        <div className="col-span-2">Actividad</div>
                        <div className="col-span-2">Descripción</div>
                        <div className="col-span-1">Entregable</div>
                        <div className="col-span-2">Observaciones</div>
                        <div className="col-span-2">Fechas</div>
                        <div className="col-span-1">Estado</div>
                        <div className="col-span-1 text-right no-print">Acción</div>
                    </div>
                    <div className="divide-y divide-zinc-100 dark:divide-zinc-800/50 min-w-[800px]">
                        {tasks.map((task, index) => (
                            <div key={task.id} className="grid grid-cols-12 gap-4 p-4 items-start hover:bg-zinc-50 dark:hover:bg-zinc-800/30 transition-colors text-sm text-zinc-600 dark:text-zinc-300 group print-row">
                                <div className="col-span-1 font-bold text-zinc-400 dark:text-zinc-500 print-cell">{index + 1}</div>
                                <div className="col-span-2 font-medium text-zinc-900 dark:text-white break-words print-cell">{task.name}</div>
                                <div className="col-span-2 text-zinc-500 dark:text-zinc-400 text-xs break-words whitespace-pre-wrap print-cell">{task.description || '-'}</div>
                                <div className="col-span-1 print-cell">
                                    {task.deliverable ? (
                                        // Entregable texto normal, sin etiquetas
                                        <div className="text-xs text-zinc-600 dark:text-zinc-300 break-words">
                                            {task.deliverable}
                                        </div>
                                    ) : <span className="text-zinc-400">-</span>}
                                </div>
                                <div className="col-span-2 text-zinc-500 dark:text-zinc-400 text-xs break-words whitespace-pre-wrap italic print-cell">
                                    {task.observations ? <span>{task.observations}</span> : <span className="text-zinc-400">-</span>}
                                </div>
                                <div className="col-span-2 flex flex-col text-xs print-cell">
                                    <span className="text-zinc-500">In: {formatDateDisplay(task.start)}</span>
                                    <span className="text-zinc-500">Fn: {formatDateDisplay(task.end)}</span>
                                </div>
                                <div className="col-span-1 print-cell">
                                    <select value={task.status} onChange={(e) => onStatusChange(task.id, e.target.value)}
                                        className={`w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded px-2 py-1 text-xs outline-none focus:border-blue-500 no-print 
                                            ${task.status === 'Completado' ? 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/10' : task.status === 'En Progreso' ? 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/10' : 'text-zinc-500 dark:text-zinc-400'}`}>
                                        <option value="Pendiente">Pendiente</option>
                                        <option value="En Progreso">En Progreso</option>
                                        <option value="Retrasado">Retrasado</option>
                                        <option value="Completado">Completado</option>
                                    </select>
                                    <span className="hidden print-only text-black text-xs font-medium">{task.status}</span>
                                </div>
                                <div className="col-span-1 text-right no-print opacity-0 group-hover:opacity-100 transition-opacity flex justify-end gap-1">
                                    <button onClick={() => onEdit(task)} className="text-zinc-400 hover:text-blue-500 dark:text-zinc-600 dark:hover:text-blue-400 transition-colors p-1 rounded"><Icons.Pencil /></button>
                                    <button onClick={() => onDelete(task.id)} className="text-zinc-400 hover:text-red-500 dark:text-zinc-600 dark:hover:text-red-500 transition-colors p-1 rounded"><Icons.Trash /></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ projects, tasks }) => {
            const totalProjects = projects.length;
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'Completado').length;
            const delayedTasks = tasks.filter(t => t.status !== 'Completado' && t.end && t.end < new Date().toISOString().split('T')[0]).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            const StatCard = ({ title, value, sub, icon: Icon, color }) => (
                <div className="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-xl flex items-start justify-between shadow-sm dark:shadow-lg">
                    <div>
                        <p className="text-zinc-500 text-sm font-medium mb-1">{title}</p>
                        <h3 className="text-3xl font-bold text-zinc-900 dark:text-white mb-2">{value}</h3>
                        <p className={`text-xs ${sub.includes('+') ? 'text-blue-600 dark:text-blue-400' : 'text-zinc-400'}`}>{sub}</p>
                    </div>
                    <div className={`p-3 rounded-lg ${color} bg-opacity-10 text-white dark:text-white`}>
                        <Icon />
                    </div>
                </div>
            );

            return (
                <div className="p-6 space-y-8 animate-in fade-in zoom-in duration-300">
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-zinc-900 dark:text-white mb-2">Bienvenido, Arquitecto</h1>
                        <p className="text-zinc-500 dark:text-zinc-400">Aquí tienes el resumen de tus operaciones hoy.</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Proyectos Activos" value={totalProjects} sub="En curso" icon={Icons.Folder} color="bg-blue-600" />
                        <StatCard title="Tareas Totales" value={totalTasks} sub="Registradas" icon={Icons.Check} color="bg-blue-600" />
                        <StatCard title="Eficiencia" value={`${completionRate}%`} sub="Tasa de éxito" icon={Icons.Chart} color="bg-blue-600" />
                        <StatCard title="Retrasos" value={delayedTasks} sub="Atención requerida" icon={Icons.Alert} color="bg-red-600" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-6">
                            <h3 className="text-lg font-bold text-zinc-900 dark:text-white mb-4">Actividad Reciente</h3>
                            <div className="space-y-4">
                                {tasks.slice(-5).reverse().map(t => (
                                    <div key={t.id} className="flex items-center justify-between pb-4 border-b border-zinc-100 dark:border-zinc-800/50 last:border-0 last:pb-0">
                                        <div>
                                            <p className="text-zinc-700 dark:text-zinc-300 font-medium">{t.name}</p>
                                            <p className="text-xs text-zinc-500">Estado: {t.status}</p>
                                        </div>
                                        <span className="text-xs text-zinc-500 dark:text-zinc-600">{formatDateDisplay(t.start)}</span>
                                    </div>
                                ))}
                                {tasks.length === 0 && <p className="text-zinc-500 text-sm">No hay actividad registrada.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportsView = ({ projects, tasks }) => {
            const byStatus = {
                'Completado': tasks.filter(t => t.status === 'Completado').length,
                'En Progreso': tasks.filter(t => t.status === 'En Progreso').length,
                'Pendiente': tasks.filter(t => t.status === 'Pendiente').length,
                'Retrasado': tasks.filter(t => t.status === 'Retrasado' || (t.status !== 'Completado' && t.end && t.end < new Date().toISOString().split('T')[0])).length
            };
            const projectStats = projects.map(p => {
                const pTasks = tasks.filter(t => t.projectId === p.id);
                const total = pTasks.length;
                const done = pTasks.filter(t => t.status === 'Completado').length;
                return { name: p.name, total, done, percent: total > 0 ? Math.round((done / total) * 100) : 0 };
            });
            const upcoming = tasks.filter(t => t.status !== 'Completado' && t.end && t.end >= new Date().toISOString().split('T')[0] && t.end <= new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0]).sort((a, b) => a.end.localeCompare(b.end));

            const StatusCard = ({ label, count, color }) => (
                <div className={`p-4 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 flex items-center justify-between`}>
                    <div>
                        <p className="text-zinc-500 text-xs font-medium uppercase tracking-wider">{label}</p>
                        <p className="text-2xl font-bold text-zinc-900 dark:text-white mt-1">{count}</p>
                    </div>
                    <div className={`w-3 h-3 rounded-full ${color}`}></div>
                </div>
            );

            return (
                <div className="p-8 space-y-8 animate-in fade-in duration-300">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-zinc-900 dark:text-white flex items-center gap-2"><Icons.Chart /> Reportes y Métricas</h2>
                        <button onClick={() => window.print()} className="text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white flex items-center gap-2 text-sm bg-zinc-200 dark:bg-zinc-800 px-3 py-2 rounded-lg transition-colors no-print">
                            <Icons.Printer className="w-4 h-4" /> Imprimir Reporte
                        </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 print-grid">
                        <StatusCard label="Completadas" count={byStatus['Completado']} color="bg-blue-600" />
                        <StatusCard label="En Progreso" count={byStatus['En Progreso']} color="bg-blue-600" />
                        <StatusCard label="Pendientes" count={byStatus['Pendiente']} color="bg-zinc-500" />
                        <StatusCard label="Retrasadas" count={byStatus['Retrasado']} color="bg-red-500" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 print-grid">
                        <div className="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-6 shadow-sm dark:shadow-lg">
                            <h3 className="text-lg font-bold text-zinc-900 dark:text-white mb-6 flex items-center gap-2"><Icons.Folder className="w-5 h-5 text-zinc-500"/> Progreso por Proyecto</h3>
                            <div className="space-y-6">
                                {projectStats.map(p => (
                                    <div key={p.name}>
                                        <div className="flex justify-between text-sm mb-2">
                                            <span className="text-zinc-700 dark:text-zinc-300 font-medium">{p.name}</span>
                                            <span className="text-zinc-500">{p.percent}% ({p.done}/{p.total})</span>
                                        </div>
                                        <div className="h-2.5 bg-zinc-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                                            <div className="h-full bg-blue-600 transition-all duration-1000" style={{width: `${p.percent}%`}}></div>
                                        </div>
                                    </div>
                                ))}
                                {projectStats.length === 0 && <p className="text-zinc-500 italic text-sm">No hay proyectos activos.</p>}
                            </div>
                        </div>
                        <div className="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-6 shadow-sm dark:shadow-lg">
                            <h3 className="text-lg font-bold text-zinc-900 dark:text-white mb-6 flex items-center gap-2"><Icons.Flag className="w-5 h-5 text-red-500"/> Próximas Entregas (7 días)</h3>
                            {upcoming.length > 0 ? (
                                <div className="space-y-3">
                                    {upcoming.map(t => (
                                        <div key={t.id} className="flex justify-between items-start p-3 bg-zinc-50 dark:bg-zinc-950/50 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 transition-colors">
                                            <div>
                                                <div className="text-sm font-medium text-zinc-900 dark:text-white">{t.name}</div>
                                                <div className="text-xs text-zinc-500 mt-0.5 flex items-center gap-1"><Icons.Box className="w-3 h-3" /> {t.deliverable || 'Sin entregable'}</div>
                                            </div>
                                            <div className="text-xs font-bold text-blue-600 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/30 px-2.5 py-1 rounded border border-blue-100 dark:border-blue-500/20">{formatDateDisplay(t.end)}</div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="h-32 flex flex-col items-center justify-center text-zinc-500 border border-dashed border-zinc-300 dark:border-zinc-800 rounded-lg">
                                    <Icons.Check className="w-6 h-6 mb-2 opacity-50" />
                                    <p className="text-sm">Todo al día.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE DE DIAGNÓSTICO ---
        const DiagnosticBanner = ({ error, onRetry, onForceOffline }) => {
            if (!error) return null;
            
            let message = "Error de conexión desconocido.";
            let action = "Reintentar";
            let link = "https://console.firebase.google.com/";
            
            if (error.code === 'permission-denied') {
                message = "IMPORTANTE: Base de datos no activa. Ve a la consola -> Firestore Database -> Crear base de datos -> Modo de prueba.";
                action = "Activar Base de Datos";
                link = "https://console.firebase.google.com/project/cronogramastack/firestore";
            } else if (error.code === 'not-found') {
                message = "CRÍTICO: La base de datos no existe. Ve a Firebase Console -> Firestore Database -> Crear base de datos.";
                action = "Crear Base de Datos";
                link = "https://console.firebase.google.com/project/cronogramastack/firestore";
            } else if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                message = "IMPORTANTE: Acceso 'Anónimo' desactivado. Ve a la consola -> Authentication -> Sign-in method -> Activar Anónimo.";
                action = "Activar Acceso";
                link = "https://console.firebase.google.com/project/cronogramastack/authentication/providers";
            } else if (error.code === 'unavailable') {
                message = "Sin conexión a internet. Trabajando en modo local.";
            }

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-red-900/95 border-t border-red-700 p-4 shadow-2xl z-50 animate-in slide-in-from-bottom-4 flex flex-col md:flex-row justify-between items-center text-white backdrop-blur-md gap-4">
                    <div className="flex items-center gap-4">
                        <div className="bg-white/10 p-2 rounded-full flex-shrink-0"><Icons.Alert /></div>
                        <div>
                            <h4 className="font-bold text-sm">Sincronización Pausada (Requiere Acción)</h4>
                            <p className="text-xs opacity-90 max-w-2xl">{message}</p>
                        </div>
                    </div>
                    <div className="flex gap-3 flex-wrap justify-center">
                        <a href={link} target="_blank" className="bg-white text-red-900 font-bold text-xs px-4 py-2 rounded hover:bg-gray-100 transition-colors flex items-center gap-2 whitespace-nowrap shadow-lg">
                             {action} <Icons.ChevronRight />
                        </a>
                        <button onClick={onForceOffline} className="text-white border border-white/30 hover:bg-white/10 text-xs px-4 py-2 rounded transition-colors whitespace-nowrap">
                            Usar en Modo Offline
                        </button>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [theme, setTheme] = useState(() => localStorage.getItem('chronotrack_theme') || 'dark');
            const [projects, setProjects] = useState([]);
            const [tasks, setTasks] = useState([]);

            const [cloudError, setCloudError] = useState(null);
            const [isCloudActive, setIsCloudActive] = useState(false);
            const [isOfflineForced, setIsOfflineForced] = useState(false);

            const [currentView, setCurrentView] = useState('dashboard');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [newTask, setNewTask] = useState({ name: '', description: '', deliverable: '', observations: '', start: '', end: '', status: 'Pendiente', progress: 0 });
            const [editingId, setEditingId] = useState(null);
            const [viewMode, setViewMode] = useState('list'); 
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                let unsubProjects = () => {};
                let unsubTasks = () => {};
                let authUnsub = () => {};

                const initApp = async () => {
                    if (isOfflineForced) return;

                    if (firebaseReady && db && auth) {
                        try {
                            authUnsub = auth.onAuthStateChanged(async (user) => {
                                if (!user) {
                                    try {
                                        await auth.signInAnonymously();
                                    } catch (err) {
                                        console.warn("Auth Failed, falling back to local:", err);
                                        setCloudError(err);
                                        loadLocalData();
                                        return;
                                    }
                                }
                                
                                try {
                                    unsubProjects = db.collection('chronotrack_projects').doc(GLOBAL_ROOM_ID)
                                        .onSnapshot({
                                            next: (doc) => {
                                                if (doc.exists && doc.data().list) {
                                                    setProjects(doc.data().list);
                                                } else if (!doc.exists) {
                                                    db.collection('chronotrack_projects').doc(GLOBAL_ROOM_ID).set({ list: [{ id: '1', name: 'Proyecto Demo', createdAt: new Date().toISOString() }] });
                                                }
                                                setIsCloudActive(true);
                                                setCloudError(null);
                                            },
                                            error: (err) => {
                                                console.warn("Firestore Error:", err);
                                                setCloudError(err);
                                                setIsCloudActive(false);
                                                loadLocalData();
                                            }
                                        });

                                    unsubTasks = db.collection('chronotrack_tasks').doc(GLOBAL_ROOM_ID)
                                        .onSnapshot({
                                            next: (doc) => {
                                                if (doc.exists && doc.data().list) {
                                                    setTasks(doc.data().list);
                                                }
                                            },
                                            error: (err) => {}
                                        });
                                } catch (err) {
                                    console.warn("DB Connection Error:", err);
                                    setCloudError(err);
                                    loadLocalData();
                                }
                            });
                        } catch (err) {
                             console.warn("General Error:", err);
                             setCloudError(err);
                             loadLocalData();
                        }
                    } else {
                        loadLocalData();
                    }
                };

                initApp();

                return () => { unsubProjects(); unsubTasks(); authUnsub(); };
            }, [isOfflineForced]);

            const loadLocalData = () => {
                const savedP = localStorage.getItem('chronotrack_projects');
                const savedT = localStorage.getItem('chronotrack_tasks');
                if (savedP) setProjects(JSON.parse(savedP));
                else setProjects([{ id: '1', name: 'Proyecto Demo', createdAt: new Date().toISOString() }]);
                if (savedT) setTasks(JSON.parse(savedT));
            };

            useEffect(() => {
                if (!isCloudActive || isOfflineForced) {
                    localStorage.setItem('chronotrack_projects', JSON.stringify(projects));
                    localStorage.setItem('chronotrack_tasks', JSON.stringify(tasks));
                }
            }, [projects, tasks, isCloudActive, isOfflineForced]);

            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') root.classList.add('dark');
                else root.classList.remove('dark');
                localStorage.setItem('chronotrack_theme', theme);
            }, [theme]);

            const activeProjectId = (currentView === 'dashboard' || currentView === 'reports') ? null : currentView;
            const activeTasks = useMemo(() => {
                const filtered = tasks.filter(t => t.projectId === activeProjectId);
                return filtered.sort((a, b) => {
                    if (!a.start) return 1; 
                    if (!b.start) return -1;
                    return new Date(a.start) - new Date(b.start);
                });
            }, [tasks, activeProjectId]);

            const activeProject = projects.find(p => p.id === activeProjectId);

            const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            const handlePrint = () => window.print();

            const updateData = (newProjects, newTasks) => {
                setProjects(newProjects);
                setTasks(newTasks);
                if (!isOfflineForced && isCloudActive && !cloudError && db && auth.currentUser) {
                    db.collection('chronotrack_projects').doc(GLOBAL_ROOM_ID).set({ list: newProjects }).catch(err => console.warn("Save failed:", err));
                    db.collection('chronotrack_tasks').doc(GLOBAL_ROOM_ID).set({ list: newTasks }).catch(err => console.warn("Save failed:", err));
                }
            };

            const handleAddProject = () => { 
                const n = prompt("Nombre:"); 
                if(n) { 
                    const id=generateId(); 
                    const newProjects = [...projects, {id, name:n, createdAt:new Date().toISOString()}];
                    updateData(newProjects, tasks);
                    setCurrentView(id); setIsSidebarOpen(false); 
                } 
            };
            
            const handleDeleteProject = () => { 
                if(confirm("¿Borrar?")) { 
                    const newProjects = projects.filter(p=>p.id!==activeProjectId);
                    const newTasks = tasks.filter(t=>t.projectId!==activeProjectId);
                    updateData(newProjects, newTasks);
                    setCurrentView('dashboard'); 
                } 
            };
            
            const handleSaveTask = (e) => { 
                e.preventDefault(); 
                // Validación opcional de fechas
                if (newTask.start && newTask.end && newTask.end < newTask.start) return alert("La fecha fin no puede ser antes del inicio");

                let updatedTasks;
                if(editingId) updatedTasks = tasks.map(t=>t.id===editingId?{...t,...newTask}:t); 
                else updatedTasks = [...tasks, {...newTask, id:generateId(), projectId:activeProjectId}]; 
                updateData(projects, updatedTasks);
                setIsModalOpen(false); setEditingId(null); setNewTask({name:'', description:'', deliverable:'', observations:'', start:'', end:'', status:'Pendiente', progress:0}); 
            };
            
            const handleEditTask = (t) => { setNewTask({...t}); setEditingId(t.id); setIsModalOpen(true); };
            
            const handleDeleteTask = (id) => {
                const updatedTasks = tasks.filter(t=>t.id!==id);
                updateData(projects, updatedTasks);
            };
            
            const updateTaskStatus = (id, s) => {
                const updatedTasks = tasks.map(t=>t.id===id?{...t, status:s, progress: s==='Completado'?100:t.progress}:t);
                updateData(projects, updatedTasks);
            };

            const handleExport = () => {
                const data = { projects, tasks };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chronotrack_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.projects && data.tasks) {
                            if(confirm(isCloudActive ? "IMPORTAR A NUBE GLOBAL: Esto cambiará los datos para TODOS. ¿Seguro?" : "IMPORTAR LOCAL: Reemplazará tus datos locales.")) {
                                updateData(data.projects, data.tasks); 
                                alert("Importación exitosa.");
                                setIsSidebarOpen(false);
                            }
                        } else {
                            alert("Formato de archivo inválido");
                        }
                    } catch (err) {
                        alert("Error al leer el archivo");
                    }
                };
                reader.readAsText(file);
                if (fileInputRef.current) fileInputRef.current.value = "";
            };

            const SidebarItem = ({ label, icon: Icon, active, onClick, badge }) => (
                <button onClick={onClick} className={`w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm font-medium transition-all group ${active ? 'bg-blue-50 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-500/20' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-900 hover:text-zinc-900 dark:hover:text-zinc-200 border border-transparent'}`}>
                    <div className="flex items-center gap-3"><Icon className={`w-5 h-5 ${active ? 'text-blue-600 dark:text-blue-400' : 'text-zinc-400 dark:text-zinc-500 group-hover:text-zinc-500 dark:group-hover:text-zinc-300'}`} /><span>{label}</span></div>
                    {badge && <span className="bg-zinc-100 dark:bg-zinc-800 text-zinc-500 dark:text-zinc-400 text-[10px] px-1.5 py-0.5 rounded-md">{badge}</span>}
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden font-sans bg-zinc-50 dark:bg-black transition-colors duration-300">
                    <DiagnosticBanner 
                        error={!isOfflineForced ? cloudError : null} 
                        onRetry={() => setCloudError(null)}
                        onForceOffline={() => {
                            setIsOfflineForced(true);
                            setCloudError(null);
                            setIsCloudActive(false);
                            loadLocalData();
                        }}
                    />
                    
                    {/* MOBILE OVERLAY */}
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={() => setIsSidebarOpen(false)}></div>}

                    {/* SIDEBAR */}
                    <aside className={`fixed inset-y-0 left-0 w-72 bg-white dark:bg-zinc-950 border-r border-zinc-200 dark:border-zinc-800 flex flex-col no-print shadow-xl z-30 transition-transform duration-300 transform md:relative md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-500/30 dark:shadow-blue-900/30"><Icons.Clock className="text-white w-5 h-5" /></div>
                                <h1 className="text-lg font-bold text-zinc-900 dark:text-white tracking-tight">Cronograpp</h1>
                            </div>
                            <button className="md:hidden text-zinc-500" onClick={() => setIsSidebarOpen(false)}>✕</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            <div className="space-y-1">
                                <p className="px-3 text-[11px] font-bold text-zinc-400 dark:text-zinc-600 uppercase tracking-wider mb-2">Menu Principal</p>
                                <SidebarItem label="Inicio" icon={Icons.Home} active={currentView === 'dashboard'} onClick={() => {setCurrentView('dashboard'); setIsSidebarOpen(false);}} />
                                <SidebarItem label="Calendario Global" icon={Icons.Calendar} onClick={() => alert("Próximamente")} />
                                <SidebarItem label="Reportes" icon={Icons.Chart} active={currentView === 'reports'} onClick={() => {setCurrentView('reports'); setIsSidebarOpen(false);}} />
                            </div>
                            <div className="space-y-1">
                                <div className="flex items-center justify-between px-3 mb-2">
                                    <p className="text-[11px] font-bold text-zinc-400 dark:text-zinc-600 uppercase tracking-wider">Espacios de Trabajo</p>
                                    <button onClick={handleAddProject} className="text-zinc-400 hover:text-blue-500 transition-colors" title="Crear Proyecto"><Icons.Plus /></button>
                                </div>
                                {projects.map(p => <SidebarItem key={p.id} label={p.name} icon={Icons.Folder} active={currentView === p.id} onClick={() => {setCurrentView(p.id); setIsSidebarOpen(false);}} badge={tasks.filter(t => t.projectId === p.id && t.status !== 'Completado').length || null} />)}
                                {projects.length === 0 && <p className="px-3 text-xs text-zinc-400 italic">Sin proyectos</p>}
                            </div>
                            <div className="space-y-1">
                                <p className="px-3 text-[11px] font-bold text-zinc-400 dark:text-zinc-600 uppercase tracking-wider mb-2">Gestión de Datos</p>
                                <div className={`px-3 py-2 text-xs rounded-lg flex items-center gap-2 mb-2 ${isCloudActive ? 'text-blue-600 dark:text-blue-400 bg-blue-500/10' : 'text-orange-600 dark:text-orange-400 bg-orange-500/10'}`}>
                                    <span className={`w-2 h-2 rounded-full ${isCloudActive ? 'bg-blue-500 animate-pulse' : 'bg-orange-500'}`}></span>
                                    {isCloudActive ? 'Nube Global Activa' : (isOfflineForced ? 'Modo Offline (Manual)' : 'Modo Offline (Error)')}
                                </div>
                                <button onClick={handleExport} className="w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm font-medium transition-all text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-900 hover:text-zinc-900 dark:hover:text-zinc-200">
                                    <div className="flex items-center gap-3"><Icons.Download className="w-5 h-5 text-zinc-400 dark:text-zinc-500" /><span>Exportar</span></div>
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm font-medium transition-all text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-900 hover:text-zinc-900 dark:hover:text-zinc-200">
                                    <div className="flex items-center gap-3"><Icons.Upload className="w-5 h-5 text-zinc-400 dark:text-zinc-500" /><span>Importar</span></div>
                                </button>
                                <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" accept=".json" />
                            </div>
                        </div>
                        <div className="p-4 border-t border-zinc-200 dark:border-zinc-800 user-profile">
                            <div className="flex items-center gap-3 p-2 rounded-xl hover:bg-zinc-100 dark:hover:bg-zinc-900 transition-colors cursor-pointer group">
                                <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-500 flex items-center justify-center text-white font-bold text-xs shadow-md">AD</div>
                                <div className="flex-1 overflow-hidden">
                                    <p className="text-sm font-medium text-zinc-700 dark:text-zinc-200 truncate">Admin User</p>
                                    <p className="text-xs text-zinc-400 dark:text-zinc-500 truncate">Pro Plan</p>
                                </div>
                                <Icons.Settings className="w-4 h-4 text-zinc-400 dark:text-zinc-600 group-hover:text-zinc-600 dark:group-hover:text-zinc-300" />
                            </div>
                        </div>
                    </aside>

                    {/* MAIN */}
                    <main className="flex-1 flex flex-col min-w-0 relative bg-zinc-50 dark:bg-black transition-colors">
                        <header className="h-16 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between px-4 md:px-8 bg-white/80 dark:bg-zinc-950/50 backdrop-blur-md sticky top-0 z-10 transition-colors">
                            <div className="flex items-center gap-3">
                                <button className="md:hidden p-2 text-zinc-500 dark:text-zinc-400 mobile-menu-btn" onClick={() => setIsSidebarOpen(true)}>
                                    <Icons.Menu />
                                </button>
                                <div>
                                    <h2 className="text-lg font-bold text-zinc-900 dark:text-white flex items-center gap-2">{currentView === 'dashboard' ? 'Panel de Control' : (currentView === 'reports' ? 'Centro de Reportes' : activeProject?.name)}</h2>
                                    <p className="text-xs text-zinc-500 no-print hidden md:block">{currentView === 'dashboard' ? `Resumen de ${projects.length} proyectos` : (currentView === 'reports' ? 'Análisis de rendimiento' : `Gestión de proyecto • ${activeTasks.length} tareas`)}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 md:gap-3 no-print">
                                <button onClick={toggleTheme} className="p-2 text-zinc-500 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors" title={theme==='dark'?'Modo Claro':'Modo Oscuro'}>
                                    {theme === 'dark' ? <Icons.Sun /> : <Icons.Moon />}
                                </button>
                                {currentView !== 'dashboard' && currentView !== 'reports' && activeProject && (
                                    <>
                                        <button onClick={handlePrint} className="p-2 text-zinc-500 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors hidden md:block" title="Imprimir"><Icons.Printer /></button>
                                        <div className="h-6 w-px bg-zinc-200 dark:bg-zinc-800 mx-2 hidden md:block"></div>
                                        <div className="flex bg-zinc-100 dark:bg-zinc-900 rounded-lg p-1 border border-zinc-200 dark:border-zinc-800">
                                            <button onClick={() => setViewMode('list')} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${viewMode === 'list' ? 'bg-white dark:bg-zinc-800 text-zinc-900 dark:text-white shadow-sm' : 'text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'}`}>Lista</button>
                                            <button onClick={() => setViewMode('gantt')} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${viewMode === 'gantt' ? 'bg-white dark:bg-zinc-800 text-zinc-900 dark:text-white shadow-sm' : 'text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'}`}>Cronograma</button>
                                        </div>
                                        <button onClick={() => { setNewTask({ name: '', description: '', deliverable: '', observations: '', start: '', end: '', status: 'Pendiente', progress: 0 }); setEditingId(null); setIsModalOpen(true); }} className="bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-500 flex items-center gap-2 shadow-lg shadow-blue-500/20 dark:shadow-blue-900/20 transition-all active:scale-95"><Icons.Plus /><span className="hidden md:inline">Nueva Tarea</span></button>
                                        <button onClick={handleDeleteProject} className="p-2 text-zinc-400 hover:text-red-500 transition-colors hidden md:block" title="Borrar Proyecto"><Icons.Trash /></button>
                                    </>
                                )}
                            </div>
                        </header>

                        <div className="flex-1 overflow-auto bg-zinc-50 dark:bg-black scroll-smooth p-4 md:p-6 transition-colors">
                            {currentView === 'dashboard' ? (
                                <Dashboard projects={projects} tasks={tasks} />
                            ) : currentView === 'reports' ? (
                                <ReportsView projects={projects} tasks={tasks} />
                            ) : (
                                <div className="h-full min-h-[500px]">
                                    <div className={`print-view-container ${viewMode === 'gantt' ? 'block' : 'hidden'} h-full print:block`}>
                                        <GanttChart tasks={activeTasks} onDelete={handleDeleteTask} onEdit={handleEditTask} />
                                    </div>
                                    <div className="hidden print:block h-8"></div>
                                    <div className={`print-view-container ${viewMode === 'list' ? 'block' : 'hidden'} print:block`}>
                                        <TaskListView tasks={activeTasks} onDelete={handleDeleteTask} onEdit={handleEditTask} onStatusChange={updateTaskStatus} />
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODAL */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 modal-overlay animate-in fade-in duration-200">
                            <div className="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 w-full max-w-lg p-6 rounded-2xl shadow-2xl animate-in zoom-in-95 duration-200 overflow-y-auto max-h-[90vh]">
                                <h3 className="text-xl font-bold mb-6 text-zinc-900 dark:text-white flex items-center gap-2">
                                    {editingId ? <Icons.Pencil /> : <Icons.Plus />} {editingId ? 'Editar Tarea' : 'Nueva Tarea'}
                                </h3>
                                <form onSubmit={handleSaveTask} className="space-y-5">
                                    <div>
                                        <label className="block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1.5 uppercase tracking-wide">Actividad</label>
                                        <input autoFocus required className="w-full bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-700 p-3 rounded-lg text-zinc-900 dark:text-white focus:border-blue-500 outline-none transition-all" value={newTask.name} onChange={e => setNewTask({...newTask, name: e.target.value})} placeholder="Ej: Diseño..." />
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="md:col-span-2">
                                            <label className="block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1.5 uppercase tracking-wide">Descripción Detallada</label>
                                            <textarea className="w-full bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-700 p-3 rounded-lg text-zinc-900 dark:text-white focus:border-blue-500 outline-none transition-all h-20 resize-none text-sm" value={newTask.description} onChange={e => setNewTask({...newTask, description: e.target.value})} placeholder="..." />
                                        </div>
                                        <div className="md:col-span-1">
                                            <label className="block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1.5 uppercase tracking-wide">Entregable Final</label>
                                            <input className="w-full bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-700 p-3 rounded-lg text-zinc-900 dark:text-white focus:border-blue-500 outline-none transition-all" value={newTask.deliverable} onChange={e => setNewTask({...newTask, deliverable: e.target.value})} placeholder="Informe..." />
                                        </div>
                                        <div className="md:col-span-1">
                                            <label className="block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1.5 uppercase tracking-wide">Observaciones</label>
                                            <textarea className="w-full bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-700 p-3 rounded-lg text-zinc-900 dark:text-white focus:border-blue-500 outline-none transition-all h-12 resize-none text-sm" value={newTask.observations} onChange={e => setNewTask({...newTask, observations: e.target.value})} placeholder="..." />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1.5 uppercase tracking-wide">Inicio (Opcional)</label>
                                            <input type="date" className="w-full bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-700 p-3 rounded-lg text-zinc-900 dark:text-white focus:border-blue-500 outline-none transition-all" value={newTask.start} onChange={e => setNewTask({...newTask, start: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1.5 uppercase tracking-wide">Fin (Opcional)</label>
                                            <input type="date" className="w-full bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-700 p-3 rounded-lg text-zinc-900 dark:text-white focus:border-blue-500 outline-none transition-all" value={newTask.end} onChange={e => setNewTask({...newTask, end: e.target.value})} />
                                        </div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between mb-1.5">
                                            <label className="block text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase tracking-wide">Progreso Inicial</label>
                                            <span className="text-xs font-bold text-blue-600 dark:text-blue-400">{newTask.progress}%</span>
                                        </div>
                                        <input type="range" min="0" max="100" className="w-full accent-blue-600 dark:accent-blue-500 h-2 bg-zinc-200 dark:bg-zinc-800 rounded-lg appearance-none cursor-pointer" value={newTask.progress} onChange={e => setNewTask({...newTask, progress: parseInt(e.target.value)})} />
                                    </div>
                                    <div className="flex justify-end gap-3 pt-4 border-t border-zinc-200 dark:border-zinc-800 mt-6">
                                        <button type="button" onClick={() => setIsModalOpen(false)} className="text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white px-4 py-2 text-sm font-medium transition-colors">Cancelar</button>
                                        <button type="submit" className="bg-blue-600 px-6 py-2 rounded-lg text-white text-sm font-medium hover:bg-blue-500 shadow-lg shadow-blue-500/20 dark:shadow-blue-900/20 transition-all active:scale-95">Guardar Tarea</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>